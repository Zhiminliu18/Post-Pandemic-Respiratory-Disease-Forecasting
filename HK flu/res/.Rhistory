'ensemble'
)
model_names <- c(
'Last year Average' = "Last year Average",
# 'GRU_base' = "GRU base",
# 'TCN_base' = "TCN base",
# 'itransformer_base' = "itransformer base",
# 'Nbeats_base' = "Nbeats base",
# 'GRU_SIR' = "GRU SIRSPF-H",
# 'TCN_SIR' = "TCN SIRSPF-H",
# 'itransformer_SIR' = "itransformer SIRSPF-H",
# 'Nbeats_SIR' = "Nbeats SIRSPF-H",
'ensemble_base' = "Base",
'ensemble' = "SIRSPF-H"
)
pred_steps <- 9
# 预定义文件路径映射'../src/{model_use}_Base_stage_holi_pf_42test.csv')
path_map <- c(
'Last year Average' = 'forc_baseline_constant3.csv',
# 'GRU_base' = glue('gru/gru_Base_stage_42test.csv'),
# 'TCN_base' = glue('tcn/tcn_Base_stage_42test.csv'),
# 'itransformer_base' = glue('itransformer/itransformer_Base_stage_42test.csv'),
# 'Nbeats_base' = glue('Nbeats/Nbeats_Base_stage_42test.csv'),
# 'GRU_SIR' = glue('gru/gru_Base_stage_holi_pf_42test.csv'),
# 'TCN_SIR' = glue('tcn/tcn_Base_stage_holi_pf_42test.csv'),
# 'itransformer_SIR' = glue('itransformer/itransformer_Base_stage_holi_pf_42test.csv'),
# 'Nbeats_SIR' = glue('Nbeats/Nbeats_Base_stage_holi_pf_42test.csv'),
'ensemble_base' = glue('ensemble_model_with_intervals_base_stage.csv'),
'ensemble' = glue('ensemble_model_with_intervals.csv')
)
# 统一处理数据的函数
process_data <- function(path) {
res <- read.csv(path) %>%
{if("mode" %in% colnames(.)) filter(., mode %in% c("train", "train_seed42")) else .} %>%
mutate(date = as.Date(date),
date_origin = date - week_ahead * 7)
invalid_dates <- res %>%
group_by(date) %>%
filter(any(true <= 1)) %>%
pull(date) %>%
unique()
res %>%
filter(!(date_origin %in% invalid_dates),
date_origin >= as.Date('2023-11-26')) %>%
na.omit()
}
# 修改主代码
plot_data <- map_dfr(models, function(model) {
res <- process_data(path_map[model])
# 使用 map 而不是 map_dbl，因为现在返回的是列表
metric_results <- map(0:(pred_steps-1), function(i) {
t <- res %>% filter(week_ahead == i)
result <- calculate_metric_with_ci(t, metric_label)
data.frame(
WeekAhead = i,
Value = result$mean,  # 均值
Lower = result$lower, # 下限
Upper = result$upper  # 上限
)
}) %>% bind_rows()  # 将列表转换为数据框
metric_results$Model <- model_names[model]
return(metric_results)
})
# 重命名Value列为实际使用的指标名称
names(plot_data)[names(plot_data) == "Value"] <- metric_label
return(plot_data)
}
color <- c(
"Last year Average" = "salmon",           # 红色
"GRU base" = "#1F77B4",           # 蓝色 (GRU)
"TCN base" = "#B7E2DB",           # 橙色 (TCN)
"Nbeats base" = "#2CA02C",        # 绿色 (Nbeats)
"itransformer base" = "#9467BD",  # 紫色 (itransformer)
"GRU SIRSPF-H" = "#1F77B4",       # 蓝色 (GRU)
"TCN SIRSPF-H" = "#B7E2DB",       # 橙色 (TCN)
"Nbeats SIRSPF-H" = "#2CA02C",    # 绿色 (Nbeats)
"itransformer SIRSPF-H" = "#9467BD", # 紫色 (itransformer)
'Base' = '#2D7D4A',
"SIRSPF-H" = "#8C4B8C"    # 浅红
)
p1 <- ggplot(get_hk_plot_data("WIS",model_use = model_use), aes(x = WeekAhead, y = WIS, color = Model,linetype = Model)) +
geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Model),
alpha = 0.2, color = NA, show.legend = FALSE) +
geom_line( linewidth = 0.6) +
geom_point( size = 0.4) +
scale_color_manual(
limits = c("Last year Average", 'Base', "SIRSPF-H"),
values = color
) +
scale_linetype_manual(
limits = c("Last year Average", 'Base', "SIRSPF-H"),
values = c('solid','solid','solid')
) +
scale_fill_manual(
limits = c("Last year Average", 'Base', "SIRSPF-H"),
values = color
) +
labs(title = "",x = 'Week ahead',y='WIS') +
theme_bw()+
theme(
legend.position = "right",
## 1. 整个图的背景
plot.background   = element_rect(fill = "transparent", colour = NA),
## 2. 绘图区（panel）
panel.background  = element_rect(fill = "transparent", colour = NA),
panel.border      = element_rect(colour = NA),          # 去掉边框
## 3. 图例整体背景 + 框
legend.background = element_rect(fill = "transparent", colour = NA),
legend.box.background = element_rect(fill = "transparent", colour = NA),
## 4. 图例键（每条线/点的背景）
legend.key        = element_rect(fill = "transparent", colour = NA),
## 5. 可选：网格淡化（不影响透明）
panel.grid.major  = element_blank(),
panel.grid.minor  = element_blank(),
axis.line              = element_line(color = "grey10", linewidth = 0.6),
axis.ticks             = element_line(color = "grey10", linewidth = 0.6),
axis.text              = element_text(color = "grey10", size = 10),
axis.title             = element_text(color = "grey10", size = 11)
)
path="forc_baseline.csv"
res_base <- read_csv(path)
df_true <- res_base %>%
select(date, true) %>%
distinct(date, .keep_all = TRUE) %>%
filter(date > '2023-12-15') %>%
mutate(period = case_when(
date >= as.Date("2023-12-15") & date < as.Date("2024-12-15") ~ "2024 Season",
date >= as.Date("2024-12-15") ~ "2025 Season"
))
p = ggplot(df_true, aes(x = date, y = true, color = '#d62728')) +
geom_line(linewidth = 1.02,color='#1f77b4') +
# geom_point(size = 0.1) +
labs(x = "Date", y = "Influenza activity (ILI+)") +
scale_x_date(
breaks = c(
as.Date("2023-03-01"),
as.Date("2023-12-01"),
as.Date("2024-12-01")
),
labels = c(
"2023\nMar",
"2023\nDec", "2024\nDec"
)
) +
theme_bw() +
theme(
plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
axis.text.x = element_text(angle = 0, hjust = 0.5, size = 10,face = "bold"),
axis.title.x = element_blank(),
axis.title.y = element_text(face = "bold"),
legend.position = "none"  # 移除图例
)
p <- p +
# 2024 Season: y = 3 的水平线（从 2023-12-15 到 2024-12-15）
annotate("segment",
x = as.Date("2023-12-01"), xend = as.Date("2024-12-01"),
y = 3.24, yend = 3.24,
color = "salmon", linewidth = 1.1, linetype = "dashed") +
# 2025 Season: y = 2.11 的水平线（从 2024-12-15 开始到数据末尾）
annotate("segment",
x = as.Date("2024-12-01"), xend = max(df_true$date),
y = 2.11, yend = 2.11,
color = "salmon", linewidth = 1.1, linetype = "dashed")
insert_subplot <- function(main_plot, subplot,
left = 0.45, bottom = 0.4,
right = 0.98, top = 0.95,
transparent = TRUE) {
# 设置透明背景
if (transparent) {
subplot <- subplot +
theme(
plot.background = element_rect(fill = "transparent", color = NA),
panel.background = element_rect(fill = "transparent")
)
}
subplot <- subplot +
theme(
plot.margin = margin(-0.15, -0.15, -0.15, -0.15, "cm"),  # 负边距裁剪
panel.spacing = unit(0, "cm"),
axis.title = element_text(margin = margin(0, 0, 0, 0)),
axis.text = element_text(margin = margin(0, 0, 0, 0))
)
# 使用 inset_element 插入子图
combined_plot <- main_plot +
inset_element(
subplot,
left = left,
bottom = bottom,
right = right,
top = top,
align_to = "panel"
)
return(combined_plot)
}
p1_new=insert_subplot(p,p1)
p1_new
library(readr)
library(ggtext)  # 用于标题阴影效果
library(grid)  # 用于添加额外文本
library(ggplot2)
library(dplyr)
library(lubridate)
library(stringr)  # 仅加载 stringr
library(patchwork)
library(purrr)  # 加载purrr包
library(ggsci)
library(glue)
library(dplyr)
library(tidyr)
library(purrr)
library(ggradar)
library(patchwork)   # 用于拼接图形 + 提取共享图例
library(scales)
library(cowplot)
# Interval score function
interval_score <- function(y, lower, upper, alpha) {
lower <- as.numeric(lower)
upper <- as.numeric(upper)
y <- as.numeric(y)
alpha <- as.numeric(alpha)
width <- upper - lower
penalty_lower <- (2 / alpha) * (lower - y) * (y < lower)
penalty_upper <- (2 / alpha) * (y - upper) * (y > upper)
return(width + penalty_lower + penalty_upper)
}
# Weighted Interval Score (WIS) function
calculate_wis <- function(row) {
intervals <- list(
list(lower = "q_1", upper = "q_99", alpha = 0.02),  # 98% PI
list(lower = "q_2", upper = "q_97", alpha = 0.05),  # 95% PI
list(lower = "q_5", upper = "q_95", alpha = 0.1),   # 90% PI
list(lower = "q_10", upper = "q_90", alpha = 0.2),  # 80% PI
list(lower = "q_15", upper = "q_85", alpha = 0.3),  # 70% PI
list(lower = "q_20", upper = "q_80", alpha = 0.4),  # 60% PI
list(lower = "q_25", upper = "q_75", alpha = 0.5),  # 50% PI
list(lower = "q_30", upper = "q_70", alpha = 0.6),  # 40% PI
list(lower = "q_35", upper = "q_65", alpha = 0.7),  # 30% PI
list(lower = "q_40", upper = "q_60", alpha = 0.8),  # 20% PI
list(lower = "q_45", upper = "q_55", alpha = 0.9)   # 10% PI
)
y <- row[["true"]]
y <- as.numeric(y)
median <- y  # Assuming median is the true value as in the original code
K <- length(intervals)  # Number of intervals
# Calculate interval scores
interval_scores <- sum(sapply(intervals, function(interval) {
0.5 * interval$alpha * interval_score(y, row[[interval$lower]], row[[interval$upper]], interval$alpha)
}))
# Median penalty
median_penalty <- 0.5 * abs(y - median)
# WIS calculation
wis <- (interval_scores + median_penalty) / (K + 0.5)
return(wis)
}
# 定义计算评估指标的函数
calculate_metrics <- function(true, pred) {
# 均方根误差 (RMSE)
rmse <- sqrt(mean((true - pred)^2))
# 平均绝对误差 (MAE)
mae <- mean(abs(true - pred))
# 平均绝对百分比误差 (MAPE)
mape <- mean(abs((true - pred)/true)) * 100
# 对称平均绝对百分比误差 (SMAPE)
smape <- mean(2 * abs(pred - true) / (abs(true) + abs(pred) + 1e-8)) * 100
# 中位数绝对误差 (Median AE)
median_ae <- median(abs(true - pred))
return(list(rmse = rmse,
mae = mae,
mape = mape,
smape = smape,
median_ae = median_ae))
}
# Weighted Interval Score (WIS) function
calculate_metric_with_ci <- function(t, metric, confidence_level = 0.5) {
metrics <- calculate_metrics(t$true, t$point)
n <- nrow(t)
z_value <- qnorm(1 - (1 - confidence_level)/2)
# 获取均值
mean_value <- switch(metric,
'RMSE' = metrics$rmse,
'MAE' = metrics$mae,
'MAPE' = metrics$mape,
'SMAPE' = metrics$smape,
'median_ae' = metrics$median_ae,
'WIS' = {
t$wis <- apply(t, 1, calculate_wis)
mean(t$wis)
},
stop("Unknown metric: ", metric))
# 计算标准误
se <- sd(switch(metric,
'RMSE' = (t$true - t$point)^2,
'MAE' = abs(t$true - t$point),
'MAPE' = abs((t$true - t$point)/t$true) * 100,
'SMAPE' = 2 * abs(t$point - t$true) / (abs(t$true) + abs(t$point) + 1e-8) * 100,
'median_ae' = abs(t$true - t$point),
'WIS' = {
if (!"wis" %in% names(t)) {
t$wis <- apply(t, 1, calculate_wis)
}
t$wis
})) / sqrt(n)
# 计算置信区间
lower <- mean_value - z_value * se
upper <- mean_value + z_value * se
return(list(
mean = mean_value,
lower = lower,
upper = upper
))
}
get_hk_plot_data <- function(metric_label,model_use = 'gru') {
models <- c('Last year Average',
# 'GRU_base', 'TCN_base','itransformer_base','Nbeats_base',
# 'GRU_SIR', 'TCN_SIR','itransformer_SIR','Nbeats_SIR',
'ensemble_base',
'ensemble'
)
model_names <- c(
'Last year Average' = "Validation year mean",
# 'GRU_base' = "GRU base",
# 'TCN_base' = "TCN base",
# 'itransformer_base' = "itransformer base",
# 'Nbeats_base' = "Nbeats base",
# 'GRU_SIR' = "GRU SIRSPF-H",
# 'TCN_SIR' = "TCN SIRSPF-H",
# 'itransformer_SIR' = "itransformer SIRSPF-H",
# 'Nbeats_SIR' = "Nbeats SIRSPF-H",
'ensemble_base' = "Base",
'ensemble' = "SIRSPF-H"
)
pred_steps <- 9
# 预定义文件路径映射'../src/{model_use}_Base_stage_holi_pf_42test.csv')
path_map <- c(
'Last year Average' = 'forc_baseline_constant3.csv',
# 'GRU_base' = glue('gru/gru_Base_stage_42test.csv'),
# 'TCN_base' = glue('tcn/tcn_Base_stage_42test.csv'),
# 'itransformer_base' = glue('itransformer/itransformer_Base_stage_42test.csv'),
# 'Nbeats_base' = glue('Nbeats/Nbeats_Base_stage_42test.csv'),
# 'GRU_SIR' = glue('gru/gru_Base_stage_holi_pf_42test.csv'),
# 'TCN_SIR' = glue('tcn/tcn_Base_stage_holi_pf_42test.csv'),
# 'itransformer_SIR' = glue('itransformer/itransformer_Base_stage_holi_pf_42test.csv'),
# 'Nbeats_SIR' = glue('Nbeats/Nbeats_Base_stage_holi_pf_42test.csv'),
'ensemble_base' = glue('ensemble_model_with_intervals_base_stage.csv'),
'ensemble' = glue('ensemble_model_with_intervals.csv')
)
# 统一处理数据的函数
process_data <- function(path) {
res <- read.csv(path) %>%
{if("mode" %in% colnames(.)) filter(., mode %in% c("train", "train_seed42")) else .} %>%
mutate(date = as.Date(date),
date_origin = date - week_ahead * 7)
invalid_dates <- res %>%
group_by(date) %>%
filter(any(true <= 1)) %>%
pull(date) %>%
unique()
res %>%
filter(!(date_origin %in% invalid_dates),
date_origin >= as.Date('2023-11-26')) %>%
na.omit()
}
# 修改主代码
plot_data <- map_dfr(models, function(model) {
res <- process_data(path_map[model])
# 使用 map 而不是 map_dbl，因为现在返回的是列表
metric_results <- map(0:(pred_steps-1), function(i) {
t <- res %>% filter(week_ahead == i)
result <- calculate_metric_with_ci(t, metric_label)
data.frame(
WeekAhead = i,
Value = result$mean,  # 均值
Lower = result$lower, # 下限
Upper = result$upper  # 上限
)
}) %>% bind_rows()  # 将列表转换为数据框
metric_results$Model <- model_names[model]
return(metric_results)
})
# 重命名Value列为实际使用的指标名称
names(plot_data)[names(plot_data) == "Value"] <- metric_label
return(plot_data)
}
color <- c(
"Validation year mean" = "salmon",           # 红色
"GRU base" = "#1F77B4",           # 蓝色 (GRU)
"TCN base" = "#B7E2DB",           # 橙色 (TCN)
"Nbeats base" = "#2CA02C",        # 绿色 (Nbeats)
"itransformer base" = "#9467BD",  # 紫色 (itransformer)
"GRU SIRSPF-H" = "#1F77B4",       # 蓝色 (GRU)
"TCN SIRSPF-H" = "#B7E2DB",       # 橙色 (TCN)
"Nbeats SIRSPF-H" = "#2CA02C",    # 绿色 (Nbeats)
"itransformer SIRSPF-H" = "#9467BD", # 紫色 (itransformer)
'Base' = '#2D7D4A',
"SIRSPF-H" = "#8C4B8C"    # 浅红
)
p1 <- ggplot(get_hk_plot_data("WIS",model_use = model_use), aes(x = WeekAhead, y = WIS, color = Model,linetype = Model)) +
geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Model),
alpha = 0.2, color = NA, show.legend = FALSE) +
geom_line( linewidth = 0.6) +
geom_point( size = 0.4) +
scale_color_manual(
limits = c("Validation year mean", 'Base', "SIRSPF-H"),
values = color
) +
scale_linetype_manual(
limits = c("Validation year mean", 'Base', "SIRSPF-H"),
values = c('solid','solid','solid')
) +
scale_fill_manual(
limits = c("Last year Average", 'Base', "SIRSPF-H"),
values = color
) +
labs(title = "",x = 'Week ahead',y='WIS') +
theme_bw()+
theme(
legend.position = "right",
## 1. 整个图的背景
plot.background   = element_rect(fill = "transparent", colour = NA),
## 2. 绘图区（panel）
panel.background  = element_rect(fill = "transparent", colour = NA),
panel.border      = element_rect(colour = NA),          # 去掉边框
## 3. 图例整体背景 + 框
legend.background = element_rect(fill = "transparent", colour = NA),
legend.box.background = element_rect(fill = "transparent", colour = NA),
## 4. 图例键（每条线/点的背景）
legend.key        = element_rect(fill = "transparent", colour = NA),
## 5. 可选：网格淡化（不影响透明）
panel.grid.major  = element_blank(),
panel.grid.minor  = element_blank(),
axis.line              = element_line(color = "grey10", linewidth = 0.6),
axis.ticks             = element_line(color = "grey10", linewidth = 0.6),
axis.text              = element_text(color = "grey10", size = 10),
axis.title             = element_text(color = "grey10", size = 11)
)
path="forc_baseline.csv"
res_base <- read_csv(path)
df_true <- res_base %>%
select(date, true) %>%
distinct(date, .keep_all = TRUE) %>%
filter(date > '2023-12-15') %>%
mutate(period = case_when(
date >= as.Date("2023-12-15") & date < as.Date("2024-12-15") ~ "2024 Season",
date >= as.Date("2024-12-15") ~ "2025 Season"
))
p = ggplot(df_true, aes(x = date, y = true, color = '#d62728')) +
geom_line(linewidth = 1.02,color='#1f77b4') +
# geom_point(size = 0.1) +
labs(x = "Date", y = "Influenza activity (ILI+)") +
scale_x_date(
breaks = c(
as.Date("2023-03-01"),
as.Date("2023-12-01"),
as.Date("2024-12-01")
),
labels = c(
"2023\nMar",
"2023\nDec", "2024\nDec"
)
) +
theme_bw() +
theme(
plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
axis.text.x = element_text(angle = 0, hjust = 0.5, size = 10,face = "bold"),
axis.title.x = element_blank(),
axis.title.y = element_text(face = "bold"),
legend.position = "none"  # 移除图例
)
p <- p +
# 2024 Season: y = 3 的水平线（从 2023-12-15 到 2024-12-15）
annotate("segment",
x = as.Date("2023-12-01"), xend = as.Date("2024-12-01"),
y = 3.24, yend = 3.24,
color = "salmon", linewidth = 1.1, linetype = "dashed") +
# 2025 Season: y = 2.11 的水平线（从 2024-12-15 开始到数据末尾）
annotate("segment",
x = as.Date("2024-12-01"), xend = max(df_true$date),
y = 2.11, yend = 2.11,
color = "salmon", linewidth = 1.1, linetype = "dashed")
insert_subplot <- function(main_plot, subplot,
left = 0.45, bottom = 0.4,
right = 0.98, top = 0.95,
transparent = TRUE) {
# 设置透明背景
if (transparent) {
subplot <- subplot +
theme(
plot.background = element_rect(fill = "transparent", color = NA),
panel.background = element_rect(fill = "transparent")
)
}
subplot <- subplot +
theme(
plot.margin = margin(-0.15, -0.15, -0.15, -0.15, "cm"),  # 负边距裁剪
panel.spacing = unit(0, "cm"),
axis.title = element_text(margin = margin(0, 0, 0, 0)),
axis.text = element_text(margin = margin(0, 0, 0, 0))
)
# 使用 inset_element 插入子图
combined_plot <- main_plot +
inset_element(
subplot,
left = left,
bottom = bottom,
right = right,
top = top,
align_to = "panel"
)
return(combined_plot)
}
p1_new=insert_subplot(p,p1)
p1_new
